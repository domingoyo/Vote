<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Display</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>

    <div class="container">
        <!-- WAITING STATE -->
        <div id="view-waiting">
            <h1 class="status-text">Ready to Join?</h1>
            <div id="qr-container">
                <canvas id="qrcode-canvas"></canvas>
            </div>
            <p class="counter">Scan to Join! | Connected: <span id="conn-count">0</span></p>
        </div>

        <!-- VOTING STATE -->
        <div id="view-voting" class="hidden">
            <h1 class="status-text">Voting In Progress...</h1>
            <div class="loader"></div> <!-- Add a CSS loader later if needed -->
            <p class="counter">Connected: <span id="conn-count-voting">0</span></p>
        </div>

        <!-- REVEAL STATE -->
        <div id="view-result" class="hidden">
            <div id="result-icon" class="result-anim"></div>
            <h1 class="status-text" id="result-text"></h1>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-drum" src="/sound/drum.MP3"></audio>
    <audio id="sfx-cheer" src="/sound/cheer.MP3"></audio>
    <audio id="sfx-fail" src="/sound/fail.MP3"></audio>

    <script>
        const socket = io();
        const views = {
            waiting: document.getElementById('view-waiting'),
            voting: document.getElementById('view-voting'),
            result: document.getElementById('view-result')
        };
        const els = {
            connCount: document.getElementById('conn-count'),
            connCountVoting: document.getElementById('conn-count-voting'),
            resultIcon: document.getElementById('result-icon'),
            resultText: document.getElementById('result-text'),
            qrCanvas: document.getElementById('qrcode-canvas')
        };
        const sfx = {
            drum: document.getElementById('sfx-drum'),
            cheer: document.getElementById('sfx-cheer'),
            fail: document.getElementById('sfx-fail')
        };

        // QR Code Generation
        // Using window.location.hostname to generate the link dynamically
        const joinUrl = window.location.protocol + '//' + window.location.hostname + ':' + window.location.port;
        QRCode.toCanvas(els.qrCanvas, joinUrl, { width: 300 }, function (error) {
            if (error) console.error(error);
            console.log('QR Generated for:', joinUrl);
        });

        function showView(name) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if(views[name]) views[name].classList.remove('hidden');
        }

        socket.on('stats', (data) => {
            els.connCount.innerText = data.connected;
            els.connCountVoting.innerText = data.connected;
        });

        socket.on('state-change', (step) => {
            if (step === 'WAITING') showView('waiting');
            if (step === 'VOTING') showView('voting');
            if (step === 'LOCKED') {
                // Keep showing voting screen or a separate locked screen?
                // For display, maybe just keep voting screen but update text
                views.voting.querySelector('h1').innerText = "Voting Locked!";
            }
        });

        socket.on('reveal', (data) => {
            showView('result');
            els.resultIcon.innerHTML = '';
            els.resultText.innerText = '';
            
            // Play Drum
            sfx.drum.currentTime = 0;
            sfx.drum.play().catch(e => console.log('Audio play failed', e));

            // Wait for drum duration (approx 3-4s usually, but let's say 3s for impact)
            // Or better, listen to 'ended' if we want perfect sync, but drumrolls usually end with a crash
            // Let's assume 3 seconds delay for suspense
            
            setTimeout(() => {
                const isPass = data.result === 'pass';
                els.resultIcon.innerHTML = isPass ? '✅' : '❌';
                els.resultText.innerText = isPass ? 'SUCCESS' : 'FAILED';
                els.resultIcon.className = 'result-anim ' + (isPass ? 'pass-icon' : 'fail-icon');
                
                if (isPass) {
                    sfx.cheer.currentTime = 0;
                    sfx.cheer.play();
                } else {
                    sfx.fail.currentTime = 0;
                    sfx.fail.play();
                }
            }, 3000); // 3 seconds drumroll
        });

        socket.on('reset', () => {
            // Stop all sounds
            Object.values(sfx).forEach(audio => { audio.pause(); audio.currentTime = 0; });
            views.voting.querySelector('h1').innerText = "Voting In Progress...";
        });

    </script>
</body>
</html>
