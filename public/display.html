<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Display</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>

<body>

    <div class="container">
        <!-- WAITING STATE -->
        <div id="view-waiting">
            <h1 class="status-text">Ready to Join?</h1>
            <div id="qr-container">
                <canvas id="qrcode-canvas"></canvas>
            </div>
            <p class="counter">Scan to Join! | Connected: <span id="conn-count">0</span></p>
        </div>

        <!-- VOTING STATE -->
        <div id="view-voting" class="hidden">
            <h1 class="status-text">Voting In Progress...</h1>
            <div class="loader"></div> <!-- Add a CSS loader later if needed -->
            <p class="counter">Connected: <span id="conn-count-voting">0</span></p>
        </div>

        <!-- REVEAL STATE -->
        <div id="view-result" class="hidden">
            <div id="result-icon" class="result-anim"></div>
            <h1 class="status-text" id="result-text"></h1>
        </div>
    </div>

    <!-- AUDIO -->
    <!-- sfx-drum is replaced by walk.webm -->
    <audio id="sfx-cheer" src="/sound/cheer.MP3"></audio>
    <audio id="sfx-fail" src="/sound/fail.MP3"></audio>

    <!-- VIDEO OVERLAYS -->
    <video id="vid-bg" class="bg-video" src="/video/bg.webm" autoplay loop muted></video>
    <video id="vid-walk" class="fullscreen-video hidden" src="/video/walk.webm"></video>
    <video id="vid-ok" class="fullscreen-video hidden" src="/video/ok.webm" muted></video>
    <video id="vid-fail" class="fullscreen-video hidden" src="/video/fail.webm" muted></video>

    <script>
        const socket = io({ query: { role: 'display' } });
        const views = {
            waiting: document.getElementById('view-waiting'),
            voting: document.getElementById('view-voting'),
            result: document.getElementById('view-result')
        };
        const els = {
            connCount: document.getElementById('conn-count'),
            connCountVoting: document.getElementById('conn-count-voting'),
            resultIcon: document.getElementById('result-icon'),
            resultText: document.getElementById('result-text'),
            qrCanvas: document.getElementById('qrcode-canvas')
        };
        const sfx = {
            cheer: document.getElementById('sfx-cheer'),
            fail: document.getElementById('sfx-fail')
        };
        const vids = {
            bg: document.getElementById('vid-bg'),
            walk: document.getElementById('vid-walk'),
            ok: document.getElementById('vid-ok'),
            fail: document.getElementById('vid-fail')
        };

        // QR Code Generation
        // Using window.location.hostname to generate the link dynamically
        const joinUrl = window.location.origin;
        QRCode.toCanvas(els.qrCanvas, joinUrl, { width: 300 }, function (error) {
            if (error) console.error(error);
            console.log('QR Generated for:', joinUrl);
        });

        function showView(name) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if (views[name]) views[name].classList.remove('hidden');
        }

        socket.on('stats', (data) => {
            els.connCount.innerText = data.connected;
            els.connCountVoting.innerText = data.connected;
        });

        socket.on('state-change', (step) => {
            if (step === 'WAITING') showView('waiting');
            if (step === 'VOTING') showView('voting');
            if (step === 'LOCKED') {
                // Keep showing voting screen or a separate locked screen?
                // For display, maybe just keep voting screen but update text
                views.voting.querySelector('h1').innerText = "Voting Locked!";
            }
        });

        socket.on('reveal', (data) => {
            showView('result');
            els.resultIcon.innerHTML = '';
            els.resultText.innerText = '';

            // Hide Background
            vids.bg.classList.add('hidden');

            // Play Walk Video (Tension)
            vids.walk.classList.remove('hidden');
            vids.walk.currentTime = 0;
            vids.walk.play().catch(e => console.error("Walk video failed", e));

            // Wait for Walk video to end
            vids.walk.onended = () => {
                vids.walk.classList.add('hidden');

                const isPass = data.result === 'pass';
                els.resultIcon.innerHTML = isPass ? '✅' : '❌';
                els.resultText.innerText = isPass ? 'SUCCESS' : 'FAILED';
                els.resultIcon.className = 'result-anim ' + (isPass ? 'pass-icon' : 'fail-icon');

                if (isPass) {
                    sfx.cheer.currentTime = 0;
                    sfx.cheer.play();

                    // Play OK video
                    vids.ok.classList.remove('hidden');
                    vids.ok.currentTime = 0;
                    vids.ok.play().catch(e => console.error("Video play failed", e));
                } else {
                    sfx.fail.currentTime = 0;
                    sfx.fail.play();

                    // Play FAIL video
                    vids.fail.classList.remove('hidden');
                    vids.fail.currentTime = 0;
                    vids.fail.play().catch(e => console.error("Video play failed", e));
                }
            };
        });

        socket.on('reset', () => {
            // Stop all sounds
            Object.values(sfx).forEach(audio => { audio.pause(); audio.currentTime = 0; });
            // Stop and hide videos
            Object.values(vids).forEach(vid => {
                vid.pause();
                vid.currentTime = 0;
                vid.classList.add('hidden');
            });
            // Show background again and play it
            vids.bg.classList.remove('hidden');
            vids.bg.play().catch(e => console.error("BG play failed", e));

            views.voting.querySelector('h1').innerText = "Voting In Progress...";
        });


    </script>
</body>

</html>